<h1>üß© B√ÄI 04 ‚Äì X√ÇY D·ª∞NG CH·ª®C NƒÇNG GI·ªé H√ÄNG V√Ä ƒê·∫∂T H√ÄNG (CART &amp; ORDER)</h1>

<h2>üéØ M·ª•c ti√™u h·ªçc t·∫≠p</h2>
<ul>
 <li>Hi·ªÉu quy tr√¨nh ho·∫°t ƒë·ªông c·ªßa ch·ª©c nƒÉng gi·ªè h√†ng v√† ƒë·∫∑t h√†ng trong h·ªá th·ªëng th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠.</li>
 <li>Thi·∫øt k·∫ø entity <b>Order</b>, <b>OrderDetail</b>, <b>CartItem</b> v√† x·ª≠ l√Ω l∆∞u tr·ªØ d·ªØ li·ªáu trong session.</li>
 <li>Th·ª±c h√†nh th√™m, c·∫≠p nh·∫≠t, x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng.</li>
 <li>Tri·ªÉn khai ch·ª©c nƒÉng thanh to√°n (Checkout) v√† l∆∞u ƒë∆°n h√†ng v√†o c∆° s·ªü d·ªØ li·ªáu.</li>
</ul>
<hr>

<h2>1. Kh√°i ni·ªám gi·ªè h√†ng</h2>
<p><b>Gi·ªè h√†ng (Cart)</b> l√† n∆°i l∆∞u t·∫°m s·∫£n ph·∫©m m√† ng∆∞·ªùi d√πng ch·ªçn tr∆∞·ªõc khi thanh to√°n. D·ªØ li·ªáu c√≥ th·ªÉ ƒë∆∞·ª£c l∆∞u:</p>
<ul>
 <li>Tr√™n session (khi ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p).</li>
 <li>Trong database (khi ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p).</li>
</ul>
<p>Spring Boot h·ªó tr·ª£ session t·ª± ƒë·ªông th√¥ng qua ƒë·ªëi t∆∞·ª£ng <code>HttpSession</code>.</p>
<hr>

<h2>2. Thi·∫øt k·∫ø m√¥ h√¨nh d·ªØ li·ªáu</h2>
<p>H·ªá th·ªëng g·ªìm c√°c entity:</p>
<ul>
 <li><b>CartItem</b>: s·∫£n ph·∫©m trong gi·ªè h√†ng.</li>
 <li><b>Order</b>: ƒë∆°n h√†ng t·ªïng.</li>
 <li><b>OrderDetail</b>: chi ti·∫øt s·∫£n ph·∫©m trong ƒë∆°n h√†ng.</li>
</ul>
<p><b>V√≠ d·ª• entity Order.java:</b></p>
<pre><code>@Entity
@Table(name = "orders")
public class Order {
 @Id
 @GeneratedValue(strategy = GenerationType.IDENTITY)
 private Long id;

 private LocalDateTime orderDate;

 private Double total;

 @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
 private List&lt;OrderDetail&gt; details;
}
</code></pre>
<p><b>V√≠ d·ª• entity OrderDetail.java:</b></p>
<pre><code>@Entity
@Table(name = "order_details")
public class OrderDetail {
 @Id
 @GeneratedValue(strategy = GenerationType.IDENTITY)
 private Long id;

 @ManyToOne
 @JoinColumn(name = "order_id")
 private Order order;

 @ManyToOne
 @JoinColumn(name = "product_id")
 private Product product;

 private int quantity;
 private double price;
}</code></pre>
<hr>

<h2>3. L∆∞u gi·ªè h√†ng b·∫±ng Session</h2>
<pre><code>@Controller
@RequestMapping("/cart")
public class CartController {

 @Autowired
 private ProductService productService;

 @GetMapping
 public String showCart(HttpSession session, Model model) {
 List&lt;CartItem&gt; cart = (List&lt;CartItem&gt;) session.getAttribute("cart");
 if (cart == null) cart = new ArrayList&lt;&gt;();
 model.addAttribute("cart", cart);
 double total = cart.stream().mapToDouble(i -&gt; i.getPrice() * i.getQuantity()).sum();
 model.addAttribute("total", total);
 return "cart";
 }

 @GetMapping("/add/{id}")
 public String addToCart(@PathVariable Long id, HttpSession session) {
 Product p = productService.getById(id);
 List&lt;CartItem&gt; cart = (List&lt;CartItem&gt;) session.getAttribute("cart");
 if (cart == null) cart = new ArrayList&lt;&gt;();
 Optional&lt;CartItem&gt; existing = cart.stream().filter(i -&gt; i.getProduct().getId().equals(id)).findFirst();
 if (existing.isPresent()) {
 existing.get().setQuantity(existing.get().getQuantity() + 1);
 } else {
 cart.add(new CartItem(p, 1));
 }
 session.setAttribute("cart", cart);
 return "redirect:/cart";
 }
}</code></pre>
<hr>

<h2>4. T·∫°o class CartItem</h2>
<pre><code>public class CartItem {
 private Product product;
 private int quantity;

 public CartItem(Product product, int quantity) {
 this.product = product;
 this.quantity = quantity;
 }

 public double getPrice() {
 return product.getPrice();
 }
 public double getTotal() {
 return getPrice() * quantity;
 }
}
</code></pre>
<hr>

<h2>5. X·ª≠ l√Ω thanh to√°n (Checkout)</h2>
<pre><code>@Controller
@RequestMapping("/order")
public class OrderController {
 @Autowired
 private OrderRepository orderRepo;

 @PostMapping("/checkout")
 public String checkout(HttpSession session) {
 List&lt;CartItem&gt; cart = (List&lt;CartItem&gt;) session.getAttribute("cart");
 if (cart == null || cart.isEmpty()) return "redirect:/cart";

 Order order = new Order();
 order.setOrderDate(LocalDateTime.now());
 order.setTotal(cart.stream().mapToDouble(CartItem::getTotal).sum());

 List&lt;OrderDetail&gt; details = cart.stream().map(item -&gt; {
 OrderDetail d = new OrderDetail();
 d.setOrder(order);
 d.setProduct(item.getProduct());
 d.setPrice(item.getPrice());
 d.setQuantity(item.getQuantity());
 return d;
 }).collect(Collectors.toList());

 order.setDetails(details);
 orderRepo.save(order);

 session.removeAttribute("cart");
 return "redirect:/order/success";
 }
}</code></pre>
<hr>

<h2>6. Giao di·ªán gi·ªè h√†ng (cart.html)</h2>
<pre><code>

Gi·ªè h√†ng

 <h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>
 <table border="1">
 <tbody><tr><th>T√™n s·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th><th>Gi√°</th><th>Th√†nh ti·ªÅn</th></tr>
 <tr>
 <td></td>
 <td></td>
 <td></td>
 <td></td>
 </tr>
 </tbody></table>
 <h3>T·ªïng c·ªông: <span></span></h3>
 
 Thanh to√°n
 

</code></pre>
<hr>

<h2>‚úÖ T·ªïng k·∫øt</h2>
<ul>
 <li>Ch·ª©c nƒÉng gi·ªè h√†ng ho·∫°t ƒë·ªông d·ª±a tr√™n session ho·∫∑c database.</li>
 <li>Checkout l∆∞u th√¥ng tin ƒë∆°n h√†ng v√† chi ti·∫øt s·∫£n ph·∫©m xu·ªëng database qua JPA.</li>
 <li>CartController v√† OrderController ch·ªãu tr√°ch nhi·ªám t√°ch bi·ªát logic v√† lu·ªìng x·ª≠ l√Ω.</li>
</ul>