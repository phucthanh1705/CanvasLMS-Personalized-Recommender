{
  "id": "lesson_bai-04-xay-dung-chuc-nang-gio-hang-va-dat-hang",
  "title": "lesson_bai-04-xay-dung-chuc-nang-gio-hang-va-dat-hang",
  "body": "<h1>üß© B√ÄI 04 ‚Äì X√ÇY D·ª∞NG CH·ª®C NƒÇNG GI·ªé H√ÄNG V√Ä ƒê·∫∂T H√ÄNG (CART &amp; ORDER)</h1>\n\n<h2>üéØ M·ª•c ti√™u h·ªçc t·∫≠p</h2>\n<ul>\n <li>Hi·ªÉu quy tr√¨nh ho·∫°t ƒë·ªông c·ªßa ch·ª©c nƒÉng gi·ªè h√†ng v√† ƒë·∫∑t h√†ng trong h·ªá th·ªëng th∆∞∆°ng m·∫°i ƒëi·ªán t·ª≠.</li>\n <li>Thi·∫øt k·∫ø entity <b>Order</b>, <b>OrderDetail</b>, <b>CartItem</b> v√† x·ª≠ l√Ω l∆∞u tr·ªØ d·ªØ li·ªáu trong session.</li>\n <li>Th·ª±c h√†nh th√™m, c·∫≠p nh·∫≠t, x√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng.</li>\n <li>Tri·ªÉn khai ch·ª©c nƒÉng thanh to√°n (Checkout) v√† l∆∞u ƒë∆°n h√†ng v√†o c∆° s·ªü d·ªØ li·ªáu.</li>\n</ul>\n<hr>\n\n<h2>1. Kh√°i ni·ªám gi·ªè h√†ng</h2>\n<p><b>Gi·ªè h√†ng (Cart)</b> l√† n∆°i l∆∞u t·∫°m s·∫£n ph·∫©m m√† ng∆∞·ªùi d√πng ch·ªçn tr∆∞·ªõc khi thanh to√°n. D·ªØ li·ªáu c√≥ th·ªÉ ƒë∆∞·ª£c l∆∞u:</p>\n<ul>\n <li>Tr√™n session (khi ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p).</li>\n <li>Trong database (khi ng∆∞·ªùi d√πng ƒë√£ ƒëƒÉng nh·∫≠p).</li>\n</ul>\n<p>Spring Boot h·ªó tr·ª£ session t·ª± ƒë·ªông th√¥ng qua ƒë·ªëi t∆∞·ª£ng <code>HttpSession</code>.</p>\n<hr>\n\n<h2>2. Thi·∫øt k·∫ø m√¥ h√¨nh d·ªØ li·ªáu</h2>\n<p>H·ªá th·ªëng g·ªìm c√°c entity:</p>\n<ul>\n <li><b>CartItem</b>: s·∫£n ph·∫©m trong gi·ªè h√†ng.</li>\n <li><b>Order</b>: ƒë∆°n h√†ng t·ªïng.</li>\n <li><b>OrderDetail</b>: chi ti·∫øt s·∫£n ph·∫©m trong ƒë∆°n h√†ng.</li>\n</ul>\n<p><b>V√≠ d·ª• entity Order.java:</b></p>\n<pre><code>@Entity\n@Table(name = \"orders\")\npublic class Order {\n @Id\n @GeneratedValue(strategy = GenerationType.IDENTITY)\n private Long id;\n\n private LocalDateTime orderDate;\n\n private Double total;\n\n @OneToMany(mappedBy = \"order\", cascade = CascadeType.ALL)\n private List&lt;OrderDetail&gt; details;\n}\n</code></pre>\n<p><b>V√≠ d·ª• entity OrderDetail.java:</b></p>\n<pre><code>@Entity\n@Table(name = \"order_details\")\npublic class OrderDetail {\n @Id\n @GeneratedValue(strategy = GenerationType.IDENTITY)\n private Long id;\n\n @ManyToOne\n @JoinColumn(name = \"order_id\")\n private Order order;\n\n @ManyToOne\n @JoinColumn(name = \"product_id\")\n private Product product;\n\n private int quantity;\n private double price;\n}</code></pre>\n<hr>\n\n<h2>3. L∆∞u gi·ªè h√†ng b·∫±ng Session</h2>\n<pre><code>@Controller\n@RequestMapping(\"/cart\")\npublic class CartController {\n\n @Autowired\n private ProductService productService;\n\n @GetMapping\n public String showCart(HttpSession session, Model model) {\n List&lt;CartItem&gt; cart = (List&lt;CartItem&gt;) session.getAttribute(\"cart\");\n if (cart == null) cart = new ArrayList&lt;&gt;();\n model.addAttribute(\"cart\", cart);\n double total = cart.stream().mapToDouble(i -&gt; i.getPrice() * i.getQuantity()).sum();\n model.addAttribute(\"total\", total);\n return \"cart\";\n }\n\n @GetMapping(\"/add/{id}\")\n public String addToCart(@PathVariable Long id, HttpSession session) {\n Product p = productService.getById(id);\n List&lt;CartItem&gt; cart = (List&lt;CartItem&gt;) session.getAttribute(\"cart\");\n if (cart == null) cart = new ArrayList&lt;&gt;();\n Optional&lt;CartItem&gt; existing = cart.stream().filter(i -&gt; i.getProduct().getId().equals(id)).findFirst();\n if (existing.isPresent()) {\n existing.get().setQuantity(existing.get().getQuantity() + 1);\n } else {\n cart.add(new CartItem(p, 1));\n }\n session.setAttribute(\"cart\", cart);\n return \"redirect:/cart\";\n }\n}</code></pre>\n<hr>\n\n<h2>4. T·∫°o class CartItem</h2>\n<pre><code>public class CartItem {\n private Product product;\n private int quantity;\n\n public CartItem(Product product, int quantity) {\n this.product = product;\n this.quantity = quantity;\n }\n\n public double getPrice() {\n return product.getPrice();\n }\n public double getTotal() {\n return getPrice() * quantity;\n }\n}\n</code></pre>\n<hr>\n\n<h2>5. X·ª≠ l√Ω thanh to√°n (Checkout)</h2>\n<pre><code>@Controller\n@RequestMapping(\"/order\")\npublic class OrderController {\n @Autowired\n private OrderRepository orderRepo;\n\n @PostMapping(\"/checkout\")\n public String checkout(HttpSession session) {\n List&lt;CartItem&gt; cart = (List&lt;CartItem&gt;) session.getAttribute(\"cart\");\n if (cart == null || cart.isEmpty()) return \"redirect:/cart\";\n\n Order order = new Order();\n order.setOrderDate(LocalDateTime.now());\n order.setTotal(cart.stream().mapToDouble(CartItem::getTotal).sum());\n\n List&lt;OrderDetail&gt; details = cart.stream().map(item -&gt; {\n OrderDetail d = new OrderDetail();\n d.setOrder(order);\n d.setProduct(item.getProduct());\n d.setPrice(item.getPrice());\n d.setQuantity(item.getQuantity());\n return d;\n }).collect(Collectors.toList());\n\n order.setDetails(details);\n orderRepo.save(order);\n\n session.removeAttribute(\"cart\");\n return \"redirect:/order/success\";\n }\n}</code></pre>\n<hr>\n\n<h2>6. Giao di·ªán gi·ªè h√†ng (cart.html)</h2>\n<pre><code>\n\nGi·ªè h√†ng\n\n <h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>\n <table border=\"1\">\n <tbody><tr><th>T√™n s·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th><th>Gi√°</th><th>Th√†nh ti·ªÅn</th></tr>\n <tr>\n <td></td>\n <td></td>\n <td></td>\n <td></td>\n </tr>\n </tbody></table>\n <h3>T·ªïng c·ªông: <span></span></h3>\n \n Thanh to√°n\n \n\n</code></pre>\n<hr>\n\n<h2>‚úÖ T·ªïng k·∫øt</h2>\n<ul>\n <li>Ch·ª©c nƒÉng gi·ªè h√†ng ho·∫°t ƒë·ªông d·ª±a tr√™n session ho·∫∑c database.</li>\n <li>Checkout l∆∞u th√¥ng tin ƒë∆°n h√†ng v√† chi ti·∫øt s·∫£n ph·∫©m xu·ªëng database qua JPA.</li>\n <li>CartController v√† OrderController ch·ªãu tr√°ch nhi·ªám t√°ch bi·ªát logic v√† lu·ªìng x·ª≠ l√Ω.</li>\n</ul>",
  "updated_at": null
}